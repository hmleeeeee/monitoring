/* =========================================
   Tokens
========================================= */
$container-max: 240rem; 
$container-vw : 98vw;

$gap    : clamp(.6rem, .9vw, 1.1rem);
$radius : clamp(.7rem, .8vw, 1.1rem);
$row-h  : clamp(7.5rem, 9.5vw, 11.5rem);
$edge-h : clamp(.32rem, .42vw, .55rem); 
$dot    : clamp(.95rem, 1.05vw, 1.35rem);
$side-w : clamp(16rem, 18vw, 22rem);
$title  : clamp(1.35rem, 1.55vw, 1.9rem);

/* 라인 균등/자동 줄바꿈(2줄 이내) */
$node-w   : clamp(4.2rem, 4.7vw, 5.4rem);
$gap-x    : clamp(.36rem, .55vw, .7rem);
$edge-min : clamp(1.4rem, 2.2vw, 2.8rem);

/* padding */
$card-pad: clamp(.75rem, .9vw, 1.1rem);
$row-pad : clamp(.35rem, .5vw, .7rem);

/* shadow */
$elev-1  : 0 8px 22px rgba(0,0,0,.06);
$elev-pop: 0 12px 32px rgba(0,0,0,.4);

/* ring */
$ring-thick: clamp(3px, .45vw, 5px);

/* acco */
$acc-gap         : clamp(2rem, .9vw, 1.1rem);
$acc-mincol      : 260px;      // 아코디언 바디 카드 최소 폭

/* =========================================
   Theme maps
========================================= */
$theme-light: (
  bg:#f6f7fb, panel:#ffffff, text:#111827, muted:#5F5F5F, muted40:rgba(107,114,128,.4),
  line:#CACACA, ring:rgba(99,102,241,.22),
  ok:#3BD156, warn:#FFC12F, danger:#F73660, unknown:#CACACA
);

$theme-dark: (
  bg:#0f172a, panel:#131f35, text:#e5e7eb, muted:#94a3b8, muted40:rgba(148,163,184,.35),
  line:#243047, ring:rgba(99,102,241,.3),
  ok:#3BD156, warn:#FFC12F, danger:#F73660, unknown:#CACACA
);

/* =========================================
   Mixins
========================================= */
@mixin focus-ring($ring){ outline:none; box-shadow:0 0 0 .25rem $ring; }

@mixin thin-scrollbar($thumb){
  scrollbar-width: thin;
  &::-webkit-scrollbar{ height:10px; width:10px; }
  &::-webkit-scrollbar-thumb{ background:$thumb; border-radius:8px; }
}

/* 2색 가로 그라데이션(라인) */
@mixin edge-gradient($from, $to){
  background: linear-gradient(90deg, $from 0%, $to 100%);
}
/* 단색 느낌(unknown) */
@mixin edge-gradient-mono($c, $alpha: .8){
  background-color: rgba($c, $alpha);
  background-image: none;
}

/* ===== Accordion ===== */
@mixin accordion-theme($t){
  .tmd-accordion {

    .tmd-acc-head {
      .tmd-card {
        background: map-get($t, panel);
        color: map-get($t, text);
        border: 1px solid map-get($t, line);
        box-shadow: $elev-1;

        .tmd-bookmark .btn-bookmark{
          background: map-get($t, panel);
          color: map-get($t, muted);
          border: 1px solid map-get($t, line);
          &:hover{ color: map-get($t, text); }
          &:focus-visible{ @include focus-ring(map-get($t, ring)); }
        }
      }

      > .btn.btn-link {
        color: map-get($t, muted);
        &:hover{ color: map-get($t, text); }
        &:focus-visible{ @include focus-ring(map-get($t, ring)); }
      }
    }

    .tmd-acc-panel{
      background: map-get($t, panel);
      border: 1px solid map-get($t, line);
      border-top: 0;
      box-shadow: $elev-1;

      .tmd-scard {
        color: #fff;
        &.ok     { background: map-get($t, ok); }
        &.danger { background: map-get($t, danger); }
        &.unknown{ background: rgba(map-get($t, unknown), 1); }
        &.warn { background: map-get($t, warn); }

        .tmd-scard__badge{
          background: rgba(255,255,255,.22);
          color: currentColor;
        }
      }
    }
  }
}

/* =========================================
   Base (theme-independent)
========================================= */
/* 헤더 */
.tmd-header--bar{
  display:grid;
  grid-template-columns: 1fr auto auto;
  align-items:center;
  column-gap: clamp(.6rem,.9vw,1.1rem);
  margin-bottom: clamp(.8rem,1vw,1.2rem);

  .tmd-title{ margin:0; font-size:$title; font-weight:700; line-height:1.12; }
  .tmd-clock{ font-size:clamp(1.3rem,1.7vw,2.1rem); font-weight:700; text-align:right; }
  .tmd-toolbar{ display:inline-flex; align-items:center; gap:clamp(.45rem,.7vw,.9rem); }
}
.has-monitoring .tmd-header--bar{ column-gap: clamp(0rem,1vw,0rem); }

/* 레이아웃 */
.tmd-layout{
  display:grid;
  grid-template-columns: minmax(0, 1fr) $side-w;
  align-items:start;
  gap: clamp(.9rem,1.2vw,1.5rem);
  overflow: visible;
  &.has-acco { grid-template-columns: minmax(0, 1fr); }
}

/* 리스트 */
.tmd-list{
  width: 100%;
  display:grid;
  gap:$gap;
  padding-right:.1rem;
}

/* 카드 */
.tmd-card{
  display:grid;
  grid-template-columns:6rem 1fr 6rem;
  grid-template-areas:"from route to";
  align-items:center;
  gap:clamp(.45rem,.9vw,1.2rem);
  border-radius: calc(#{$radius} + .2rem);
  padding:$card-pad;

  min-height:$row-h;
  max-height: clamp(11rem, 24vw, 21rem);

  .tmd-from{ grid-area:from; }
  .tmd-to  { grid-area:to; }
}
.tmd-label{ font-weight:800; text-align:center; font-size:clamp(.88rem,.95vw,1.05rem); }

.tmd-route{ grid-area:route; }
.tmd-track{ position:relative; padding:$row-pad .1rem; overflow:hidden; }

/* 그리드(세로 스택) */
.tmd-grid{ display:flex; flex-direction:column; row-gap: clamp(.55rem,.75vw,.95rem); }

/* 행: 가로 가운데 정렬(노드/엣지) */
.tmd-row{
  display:flex; /*align-items:center;*/ justify-content:center;
  column-gap:$gap-x; row-gap: clamp(.35rem,.5vw,.7rem);
  max-width:100%; min-width:0;
}

/* 노드: 고정폭, 중앙정렬 */
.tmd-node{
  flex: 0 0 $node-w; 
  min-width:$node-w;
  display:grid; 
  place-items:center; 
  text-align:center;

  /* 자식 버튼이 부모에 의해 늘어나지 않도록 */
  > .tmd-dotbtn{
    justify-self:center;
    align-self:center;
  }
}

/* 블렛(링): 단색 + border 두께로 정비율(원형) 보장 */
.tmd-dotbtn{
  width:$dot;
  height:$dot;
  aspect-ratio:1 / 1;
  padding:0; margin:0;
  line-height:0;
  appearance:none; -webkit-appearance:none;
  border-radius:9999px;
  box-sizing:border-box;
  background:transparent;
  border:$ring-thick solid rgba(#000,.12);
  flex:0 0 auto;
  display:inline-block;
}

.tmd-nlabel{
  margin-top:.32rem; font-size:clamp(.74rem,.82vw,.94rem);
  max-width:100%; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; text-align:center;
}

/* 엣지(라인): 동일 분배 + 최소 길이 보장 */
.tmd-edge{
  flex: 1 1 $edge-min; min-width:$edge-min;
  height:$edge-h; border-radius:999px;
  margin-top: calc((#{$dot} / 2) - (#{$edge-h} / 2));
}

/* 우측 패널: sticky */
.tmd-side{
  --stick-top: clamp(.5rem, 1vw, 1rem);
  position:sticky; top:var(--stick-top);
  align-self:start; display:grid; gap:.7rem;
}

/* 패널 */
.tmd-panel{
  display:flex; flex-direction:column;
  min-height: 50vh;
  max-height: calc(100vh - var(--stick-top) - clamp(1rem,1.2vw,1.5rem));
  padding: clamp(.9rem,1vw,1.2rem) !important;
  border-radius:$radius;

  .tmd-kv{
    display:grid; grid-template-columns:8rem 1fr;
    gap:.5rem .6rem; margin-bottom:0; font-size:clamp(.72rem,.8vw,.92rem);
    dt{ margin:0; text-align:left; font-weight:500; }
    dd{ margin:0; text-align:right; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
  }
}

/* =========================================
   Accordion (base / theme-independent)
========================================= */
.tmd-accordion{
  display: grid;
  gap: $gap; /* 아이템 간격: 토큰(clamp) */

  /* 부트스트랩 card 리셋 */
  .tmd-acc-item.card{
    background: transparent;
    border: 0;
    box-shadow: none;
    overflow: visible;
  }

  /* ---------------- Header ---------------- */
  .tmd-acc-head.card-header{
    position: relative;
    padding: 0;
    background: transparent;
    border: 0;
    // &:first-child{ border-radius: 0; }

    /* 헤더 내부 카드(Bookmark | Route | Util) */
    > .tmd-card{
      display: grid;
      grid-template-columns: auto 1fr auto;   /* bookmark | route | util */
      grid-template-areas: "bookmark route util";
      align-items: center;
      column-gap: clamp(.6rem, .9vw, .6rem);

      /* 높이/패딩/라운드: 모두 토큰(clamp) */
      min-height: $row-h;
      padding: $acc-gap;
      border-radius: calc(#{$radius} + .2rem);

      .tmd-bookmark{ grid-area: bookmark; }
      .tmd-route   { grid-area: route; }
      .tmd-utill   { grid-area: util;  }

      /* --- Bookmark 버튼 --- */
      .tmd-bookmark{
        display: flex; align-items: center;

        .btn-bookmark{
          width: clamp(28px, 1.6vw, 36px);
          height: clamp(28px, 1.6vw, 36px);
          aspect-ratio: 1 / 1;
          border-radius: 50%;
          display: inline-grid; place-items: center;
          padding: 0; line-height: 0;
          transition: transform .15s ease, box-shadow .2s ease;

          i{ font-size: clamp(.86rem, .95vw, 1.05rem); }
        }
      }

      /* --- Util(상태 라벨 + 토글) --- */
      .tmd-utill{
        display: inline-flex; align-items: center; justify-content: space-between;
        min-width: 5rem; gap: clamp(.5rem, .8vw, 1rem);

        .tmd-status{
          color:#F73660;
          font-weight: 700;
          font-size: clamp(0.9375rem, 1.0vw, 1.25rem);
          line-height: 1;
          white-space: nowrap;
        }

        > .btn.btn-link{
          width:  clamp(44px, 1.6vw, 56px);
          height: clamp(44px, 1.6vw, 56px);
          display: inline-grid; place-items: center;
          border-radius: clamp(10px, .6vw, 14px);
          padding: 0; line-height: 0;
          text-decoration: none;
          transition: transform .15s ease, box-shadow .2s ease, color .15s ease;

          i{ color: #CACACA; font-size: clamp(1.5rem, 1.4vw, 2rem); transition: transform .18s ease; }
        }
      }
    }

    /* 펼침 상태 아이콘 회전 */
    [data-toggle="collapse"][aria-expanded="true"] i{
      transform: rotate(180deg);
    }
  }

  /* ---------------- Panel ---------------- */
  .tmd-acc-body {
    .tmd-acc-panel{
      padding: clamp(.8rem, 1.1vw, 1.4rem);

      /* 4열 그리드 */
      .tmd-sgrid{
        display: grid;
        grid-template-columns: repeat(4, minmax(0, 1fr));
        gap: clamp(.8rem, 1.1vw, 1.4rem);
        padding: 0 7rem 0 3.8rem;
      }

      /* 상태 카드 공통 레이아웃 */
      .tmd-scard{
        position: relative;
        border-radius: clamp(12px, .9vw, 16px);
        padding: clamp(24px, 1.95vw, 33px) clamp(16px, 1.3vw, 22px);
        box-shadow: $elev-1;

        &__head{
          display: flex;
          align-items: center;
          justify-content: space-between;
          margin-bottom: clamp(6px, .5vw, 10px);
          gap: .6rem;
        }

        &__title{
          margin: 0;
          font-weight: 800;
          font-size: clamp(1.25rem, 1.4vw, 1.75rem);
          line-height: 1.1;
          letter-spacing: -0.01em;
        }

        &__badge{
          flex: 0 0 auto;
          display: grid;
          place-items: center;
          width: clamp(34px, 1.85vw, 44px);
          height: clamp(34px, 1.85vw, 44px);
          border-radius: 50%;
          background: rgba(255,255,255,.22);
          i{ font-size: clamp(.95rem, 1vw, 1.15rem); }
        }

        /* 구간 경로 */
        &__route{
          margin: 0 0 clamp(10px, .7vw, 12px);
          font-size: clamp(.92rem, .9vw, 1.2rem);
          line-height: 1.25;
        }

        /* 메타 2열 (좌: Device, 우: 범위) */
        &__meta{
          display: grid;
          grid-template-columns: 1fr;
          gap: clamp(6px, .6vw, 10px) clamp(4px, 1vw, 6px);
          margin: 0;

          > div{
            display: grid;
            grid-template-columns: 1fr 1fr;
            column-gap: clamp(4px, .35vw, 6px);
            align-items: baseline;
          }

          dt{
            margin: 0;
            font-size: clamp(.78rem, .85vw, .92rem);
            font-weight: 600;
          }
          dd{
            margin: 0;
            font-size: clamp(.78rem, .85vw, .92rem);
            text-align: right;
          }
        }
      }
    }

    /* 큰 화면에서 살짝 여백 업 */
    @media (min-width: 1920px){
      .tmd-acc-panel .tmd-sgrid{
        gap: clamp(1rem, .9vw, 1.4rem);
      }
    }
  }
  .tmd-acc-panel.card-body{
    margin-top: -1px;
    padding: clamp(2rem, 0.9vw, 1.1rem);
    border-radius: calc(#{$radius} + .2rem);
    border-top-left-radius: 0;
    border-top-right-radius: 0;
    overflow: visible;
  }

  .tmd-acc-item {
    /* 열린 상태(= collapse.show) */
    &:has(> .collapse.show) {
      .tmd-acc-head .tmd-card{
        border-bottom-left-radius: 0;
        border-bottom-right-radius: 0;
      }
      .tmd-acc-panel{
        border-top-left-radius: 0;
        border-top-right-radius: 0;
      }
    }
  }
}

/* popover */
.tmd-popover{
  &[hidden]{ display:none; }

  .tmd-sheet{
    position:fixed; z-index:1080;
    width: clamp(13rem, 15vw, 17rem);
    padding: clamp(.5rem, .7vw, .8rem);
    background:#2b2f36; color:#f3f4f6;
    border:1px solid rgba(255,255,255,.08);
    border-radius: calc(#{$radius} - .3rem);
    box-shadow:$elev-pop;

    .thd-shhet-header{
      display:flex; align-items:center; justify-content:space-between;
      gap:.4rem; margin-bottom:.4rem;
    }
    .tmd-p-title{
      margin:0; color:$grays-0;
      font-size: clamp(0.846rem, calc(0.15625vw + 0.692rem), 0.923rem);
      font-weight:600;
    }
    .tmd-close{
      all:unset; cursor:pointer; padding:.2rem .35rem;
      border-radius:.45rem; color:$grays-0;
      &:focus-visible{ box-shadow:0 0 0 .18rem rgba(255,255,255,.18); }
    }
  }

  .tmd-kv{
    display:grid; grid-template-columns:7rem 1fr;
    margin-bottom: 0;
    gap:.2rem .4rem;
    font-size: clamp(0.846rem, calc(0.15625vw + 0.692rem),  0.923rem);
    dt{ color:$grays-1; font-weight:500; }
    dd{ color:$grays-1; font-weight:400; }
  }
}

/* =========================================
   Theme attach
========================================= */
@mixin theme-apply($scope, $t){
  #{$scope}{
    background: map-get($t,bg);
    color:      map-get($t,text);

    .tmd-wrap{
      max-width: min($container-max, $container-vw);
      margin: clamp(1.2rem, 1.8vw, 2.2rem) auto clamp(1.4rem, 2vw, 2.6rem);
      padding: 0 clamp(1rem, 1.6vw, 2rem) clamp(1.1rem, 1.6vw, 2rem);
    }
    .tmd-title{ color: map-get($t,text); }
    .tmd-toolbar .tmd-btn{
      border:1px solid map-get($t,line);
      background: map-get($t,panel);
      color: map-get($t,text);
      border-radius: calc(#{$radius} - .25rem);
      padding:.55em .85em; font-size:clamp(.84rem,.9vw,1rem);
      cursor:pointer; transition:box-shadow .2s, transform .02s;
      &:active{ transform: translateY(1px); }
      &:focus-visible{ @include focus-ring(map-get($t,ring)); }
    }
    .tmd-card{
      background: map-get($t,panel);
      border:1px solid map-get($t,line);
      color: map-get($t,text);
      box-shadow:$elev-1;
    }
    .tmd-panel{
      background: map-get($t,panel);
      border:1px solid map-get($t,line);
      box-shadow:$elev-1;

      &>h3{
        color: map-get($t,text);
        font-weight:600;
        margin: 0 0 clamp(.55rem,.8vw,1rem) !important;
      }
    }

    .tmd-label{ color: map-get($t,text); }
    .tmd-nlabel{ color: map-get($t,muted); }
    .tmd-clock{ color: map-get($t,muted); }

    /* 블렛(링) — 단색 + border 두께로 제어 (정비율 유지) */
    .tmd-dotbtn{
      border: $ring-thick solid rgba(map-get($t, unknown), .8);
      &.ok     { border-color: map-get($t, ok); }
      &.warn   { border-color: map-get($t, warn); }
      &.danger { border-color: map-get($t, danger); }
      &.unknown{ border-color: rgba(map-get($t, unknown), .8); }
    }

    /* 라인(엣지) — 그라데이션 */
    .tmd-edge{
      &.ok     { @include edge-gradient(#9DFFAE, #3BD156); }  // 0%→100%
      &.warn   { @include edge-gradient(#FFE066, #FFCA09); }
      &.danger { @include edge-gradient(#FFBDCB, #F73660); }
      &.unknown{ @include edge-gradient-mono(map-get($t, unknown)); }
    }

    @include accordion-theme($t);
  }
}

/* Mount themes */
@include theme-apply('body[data-theme="light"]', $theme-light);
@include theme-apply('body[data-theme="dark"]',  $theme-dark);